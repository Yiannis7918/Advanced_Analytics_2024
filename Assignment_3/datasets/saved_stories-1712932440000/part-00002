{"aid": "40010514", "title": "A cost-effective Intel W680 ECC server: repurposing an HP Z2 G9 motherboard", "url": "https://forums.servethehome.com/index.php?threads/a-cost-effective-intel-w680-ecc-server-repurposing-an-hp-z2-g9-motherboard.43943/", "domain": "servethehome.com", "votes": 3, "user": "cromka", "posted_at": "2024-04-12 08:33:10", "comments": 0, "source_title": "A cost-effective Intel W680 ECC server: repurposing an HP Z2 G9 motherboard", "source_text": "A cost-effective Intel W680 ECC server: repurposing an HP Z2 G9 motherboard | ServeTheHome Forums\n\nMenu\n\n# A cost-effective Intel W680 ECC server: repurposing an HP Z2 G9 motherboard\n\n  * Thread starter cromo\n  * Start date Yesterday at 12:19 PM\n\n  * Home\n\n  * Forums\n\n  * Hardware\n\n  * Processors and Motherboards\n\nNotice: Page may contain affiliate links for which we may earn a small\ncommission through services like Amazon Affiliates or Skimlinks.\n\nC\n\n#### cromo\n\n##### Member\n\n    Jun 6, 2019\n\n    90\n\n    19\n\n    8\n\nYesterday at 12:19 PM\n\n  * #1\n\nI asked a while ago whether anyone tried to repurpose an HP Z2 G9 Tower/Lenovo\nThinkStation P3 W680 Tower/Dell Precision 3660 W680-based workstation\nmotherboard and got no response, so I decided to go ahead and do it myself.\n\nI managed to buy a second-hand HP Z2 G9 W680 motherboard for less than \u20ac100\nand within the last 3 months had gained enough experience with it to share\nhere with the community. Considering all other W680 motherboards cost upwards\nUSD 500 at this point, this turns out to be a fairly attractive solution to\nget a modern Intel system with low idle power consumption, PCIe Gen 5, and,\nmost importantly, ECC memory support. Interestingly, I saw some recent eBay\nlistings that sold those motherboards for as little as 20-40 USD!\n\nThe HP Z2 G9 system spec is here, motherboard details on page 17:\nhttps://h20195.www2.hp.com/v2/getpdf.aspx/c08109687.pdf The spec of the\nmotherboard itself can be looked up in the Service Manual here, page 51:\nhttps://kaas.hpcloud.hp.com/pdf-public/pdf_5451169_en-US-1.pdf\n\nI originally had it running with 12600k, I since upgraded to 13600k (more on\nthat later).\n\nThere are a few challenges running it, compared to your run-of-the-mill\nproducts:\n\n1\\. PSU\n\nHP, Dell, and Lenovo all use proprietary PSUs, which at least in case HP are\nactually conformant to ATX12VO. That means the PSUs themselves only deliver\n12V to the board, which then handles the 5V supply by itself. This also means\nthat using off-the-self PSU is very limited, especially because the board\nexpects +12VSB (stand-by voltage), as opposed to the standard 5V. There are\nworkarounds available (google it), but I resorted to using an HP power supply.\n\nFor the record, while the HP Z2 G9 comes can be configured with 3 different\nPSUs, you can use PSUs from other systems. Notably, the PSU must have a 7-pin\nPWRCMD connector, as opposed to a 6-pin That is, however, not enough, as not\nall PSUs have enough cables connected to it, and my conclusion at this point\nis that any PSU with *black cabling* and a 7-pin PWRCMD connector will work\nwith this system. I am myself using it with an HP G5 450W PSU, which has Gold\ncertification (Platinum ones are also available).\n\nAlso worth noting is that there isn't anything proprietary about those PSUs\noutside of the connectors: all of the cabling is standard ATX. In fact, before\nthey switched to using all-black cabling, all of the cable colors used matched\nthe ATX standard.\n\n2\\. FANs\n\nAnother proprietary solution is HP fan connectors. They are compatible with\nregular PWM fans, but the HP CPU fan comes with 5 pins, instead of regular 4.\nPins 1-4 are the same as in the standard, pin number 5 is crucial to get the\nsystem to NOT report fan incompatibility upon POST.\n\nTheir fans come in at 65W and 125W TDP versions. So far, what I found, is that\nto emulate 125W, one needs to connect pins 3 and 5. Shorting pins 3, 4, and 5\nwill allow the system to not report when the fan is missing entirely. More on\nthat later.\n\nThe system will also report a missing chassis fan, CHFAN2 (P9 in manual). This\none is a regular, 4-pin one. The solution here is to short pins 3 and 4.\n\nThe problem, unfortunately, is that HP fan implementation is not exposed to\nthe system, so lm-sensors is not able to control them. That wouldn't be that\nbad if not for the fact that they tie the fan speed to the CPU usage, not the\ntemperature. And this in itself wouldn't be a problem if they didn't tie them\nto a *single core* usage, which results in fans blasting as soon as the system\nsees even modest utilization, around 3-5%.\n\nSee this thread on HP forums for details: Re: HP Z2 G9 \u2014 CPU Fan starts\nspinning at full speed even if only one or two cores are at 100% usage\n\nWith that in mind, you need to resort to an external fan controller to take\nthe control back. You'll also need to short pins 3, 4, and 5, as explained\nabove, to avoid the POST complaints. Some recommended options are Corsair and\nNZXT, which luckily come with Linux kernel support, together with liquidctl to\ncontrol them. More here: liquidctl\n\n3\\. Motherboard and its non-standard size\n\nAll of these HP/DELL/Lenovo motherboards come in non-standard sizes. They are\nMicro-ATX by lengths, but exceptionally wide. This has both pros and cons:\n\n  1. You can't use them in regular ATX cases, most likely. I don't have a problem with it, since I have it installed in a custom IKEA shelving\n  2. Excellent IOMMU grouping. Pretty much every single device has its own group. No ACS overrides needed. No issues in passing GPU, Mellanox SRIOV VFs, or SATA controller to the VMs.\n  3. 3 x NVMe PCIe4 x4 slots + 1 x m2 PCIe3 x1\n  4. HP Flex IOv2 connector. That means you can get an extra 10Gbit NIC or install a relatively inexpensive HP 3UU05AA Thunderbolt 3 extension card (which takes up PCI slot 4 as well).\n  5. I219-LM Gigabit Ethernet with vPro support.\n  6. Extra USB connectors on the other end of the board\n  7. Only 4 PCI slots. Slot 1 is PCIe5 x16. The rest are PCIe3 x1, x4, x4. A 2.5-width GPU card will leave you with a single PCI slot 4 free \u2014 unless you resort to some creative PCI ribbon risers.\n  8. 4 SATA ports. You need a \"P160 HP cable\" to power the disks, as the PSU being ATX12VO does not come with SATA power cabling.\n  9. There's an onboard USB header, used to connect the Media Card reader, but it is non-standard, so you can't use it to connect the Corsair/NZXT fan controller.\n\n4\\. Issues running it\n\n13th gen \"PCA not fully compatible\" error\n\nAfter updating to the 13th gen, I am seeing a \"PCA not fully compatible\"\nerror. This is actually discussed here on the forums, too, affecting the HP Z2\nG9 Mini system. I have no clue what's causing this: the fan is rather unlikely\nsince you can disconnect it altogether and the SKU error still shows, followed\nby the \"missing fan\" error. The PSU is also unlikely, since AFIK there's no\nway for the motherboard to know the model of the PSU connected. There is\nanother revision of the motherboard, which is said was released to fix some\n13/14th gen compatibility issues, but HP themselves have not confirmed that,\nand all of the posts on their forums that ask for help with the very same\nissue were left with no response from HP.\n\nUnfortunately, the system will not post past this error unless you acknowledge\nit with a keyboard press. I did not notice any other compatibility issues with\nthe 13th gen on top of the 12th gen. Goes without saying the firmware is up to\ndate.\n\nPower consumption\n\nWith no external devices connected and the system idling, 64GB (2 x 32 GB) ECC\nRAM, and 2 x Lexar NM 710 1 TB SSDs, the power consumption measured off the\nwall is 4.5-6W, which is astonishing (with only 1W difference between 12600k\nand 13600k). It could potentially get even a bit better with a Platinum PSU.\nAMD clearly cannot compete here at all. For the record, the system would reach\nC10 states with 12600k and C8 states with 13600k. I am not sure if the latter\nis expected \u2014 rather not.\n\nUnfortunately, some serious problems start as soon as I connect PCI devices.\nSpecifically, with the AMD 6600 XT GPU connected to slot 1, the system will no\nlonger enter deeper C-states, stopping at C2. I believe this is because the\nPCIe5 slot 1 is connected directly to the CPU, which apparently limits the C\nstates to 2, as explained here. So while the GPU is very efficient, idling at\n4 W only, the system's consumption spikes up to 40-55W. Combined with my\nMellanox 4 LX and some USB devices + 4 x 2.5\" idling HDDs, the total idle\nconsumption is 55W-70W. This is, unfortunately, on par with similarly\nconfigured, idling AM5, with regular, off-the-shelf components.\n\nIt's worth noting that all of the devices have ASPM enabled, as reported by\nthe lspci. I am left without ideas here, I asked on HP forums, but I doubt I\nwill be met with any help: Z2 G9: unable to reach C-state above 2 with GPU\ninstalled in PCIe5 slot\n\nNoteworthy, HP specs suggest a similarly specced system, i9 12900 with NVIDIA\nGPU, should idle at 22-24W in Windows. This is considering NVIDIA GPUs are\nactually worse than AMDs in idle. I have not tested the system with Windows\nyet, it would be interesting to see whether I can confirm those numbers \u2014\nespecially in light of what is reported on C2 levels enforced by occupying\nCPU-bound PCI slots.\n\nRAM issues with Intel x710 NIC\n\nAnother weird issue is happening with an Intel x710 installed in PCI slot 4 in\nplace of the Mellanox. I figured I would want to reduce the overall power\nconsumption by using the Intel NIC, which is reported to be more power\nefficient. Unfortunately, with Intel NIC installed, the system POSTs with half\nof the memory, i.e. 32GB in my case. Super odd issue, I would need to have\nsomeone try to replicate it, otherwise it may sound like the motherboard is\nsomehow broken. Although it's interesting that I am not getting such an issue\nwith the Mellanox installed.\n\nRAM speed limited to 4400/4000 MT/s\n\nAs explained below by [B][SIZE=5]zir_blazer[/SIZE][/B], this works as intended\non this platform.\n\nThere's some off limitation of memory speed imposed by this system. With two\nmodules installed, my 48000 MT/s memory is effectively limited to 4400 MT/s,\nwhich I have confirmed using lshw\n\nTurbo speeds\n\nI am convinced the motherboard limits the socket to 125W and, as a result, the\nCPU will hardly ever get close to the Turbo speeds, even if the thermals\npermit it. This is with the High-Performance Mode enabled in BIOS.\n\nUndervolting/Overvolting\n\nThis being a proprietary system means you cannot underplot the CPU, which has\nthe potential of reducing the consumption significantly with Intel CPUs.\n\nSummary\n\nAll things considered, whether this is a viable platform depends on whether\nthe issues above are fixable. Having to manually press \"Enter\" to boot with a\n13th gen CPU can be worked around by resorting to a 12th gen CPU. However, if\nyou want to use it with extra PCI devices, you need to consider the idle power\nconsumption issues, which then make this system lose its advantages over the\nAMD AM5 platform. Other than that, the system has been very stable, not having\ncrashed once in the lasts 3 months.\n\nAll things considered, if you can get ahold of an off-the-shelf W680\nmotherboard at a reasonable price, I wouldn\u2019t bother getting your hands dirty\nwith this approach.\n\nLast edited: Today at 1:44 AM\n\nReactions: piranha32\n\nZ\n\n#### zir_blazer\n\n##### Active Member\n\n    Dec 5, 2016\n\n    356\n\n    128\n\n    43\n\nYesterday at 12:57 PM\n\n  * #2\n\n> cromo said:\n>\n> RAM speed limited to 4400/4000 MT/s\n>\n> There's some off limitation of memory speed imposed by this system. With two\n> modules installed, my 48000 MT/s memory is effectively limited to 4400 MT/s,\n> which I have confirmed using lshw\n>\n> View attachment 36015\n>\n> Click to expand...\n\nWorking as intended. Alder Lake supports DDR5 4800 MHz and Raptor Lake 5600\nONLY IF THE MOTHERBOARD HAS ONE SLOT PER CHANNEL. Motherboard has 4 Slots?\n4400 max for best case, which is 1 DPC installed.\n\n> cromo said:\n>\n> Turbo speeds\n>\n> I am convinced the motherboard limits the socket to 125W and, as a result,\n> the CPU will hardly ever get close the Turbo speeds, even if the thermals\n> permit it. This is with the High Performance Mode enabled in BIOS.\n>\n> Click to expand...\n\nYou could check with ThrottleStop or Intel XTU in Windows what the PL1/PL2\nvalues are.\n\nC\n\n#### cromo\n\n##### Member\n\n    Jun 6, 2019\n\n    90\n\n    19\n\n    8\n\nYesterday at 1:01 PM\n\n  * #3\n\n> zir_blazer said:\n>\n> Working as intended. Alder Lake supports DDR5 4800 MHz and Raptor Lake 5600\n> ONLY IF THE MOTHERBOARD HAS ONE SLOT PER CHANNEL. Motherboard has 4 Slots?\n> 4400 max for best case, which is 1 DPC installed.\n>\n> Click to expand...\n\nThanks, at least this is sorted.\n\n> You could check with ThrottleStop or Intel XTU in Windows what the PL1/PL2\n> values are.\n>\n> Click to expand...\n\nturbostat lists that too:\n\nCode:\n\n    \n    \n    cpu0: MSR_RAPL_POWER_UNIT: 0x000a0e03 (0.125000 Watts, 0.000061 Joules, 0.000977 sec.) cpu0: MSR_PKG_POWER_INFO: 0x000003e8 (125 W TDP, RAPL 0 - 0 W, 0.000000 sec.) cpu0: MSR_PKG_POWER_LIMIT: 0x4285a800e383e8 (UNlocked) cpu0: PKG Limit #1: ENabled (125.000 Watts, 224.000000 sec, clamp ENabled) cpu0: PKG Limit #2: ENabled (181.000 Watts, 0.002441* sec, clamp DISabled)\n\nSo I guess it is not limited, after all. That is assuming these values take\nmotherboard limitations into consideration?\n\nLast edited: Yesterday at 1:07 PM\n\nR\n\n#### RolloZ170\n\n##### Well-Known Member\n\n    Apr 24, 2016\n\n    5,250\n\n    1,582\n\n    113\n\nYesterday at 1:02 PM\n\n  * #4\n\n> zir_blazer said:\n>\n> Motherboard has 4 Slots? 4400 max for best case, which is 1 DPC installed.\n>\n> Click to expand...\n\nsearch and find Enforce POR in the BIOS, set to disabled and the RAM keeps\n4400. after that run memtest to be sure the cpu/board/ram combo can do this\nwithout errors.\n\nC\n\n#### cromo\n\n##### Member\n\n    Jun 6, 2019\n\n    90\n\n    19\n\n    8\n\nYesterday at 1:03 PM\n\n  * #5\n\n> RolloZ170 said:\n>\n> search and find Enforce POR in the BIOS, set to disabled and the RAM keeps\n> 4400. after that run memtest to be sure the cpu/board/ram combo can do this\n> without errors.\n>\n> Click to expand...\n\nYou won't find such an option in proprietary systems like this one, which\nvalue stability over functionality/performance.\n\nShow hidden low quality content\n\nYou must log in or register to reply here.\n\nShare:\n\nFacebook Twitter Reddit Pinterest Tumblr WhatsApp Email Link\n\n  * STH Pro\n\n  * Contact us\n  * Terms and rules\n  * Privacy policy\n  * Help\n  * Home\n  * RSS\n\nTop Bottom\n\n  * This site uses cookies to help personalise content, tailor your experience and to keep you logged in if you register. By continuing to use this site, you are consenting to our use of cookies.\n\nAccept Learn more...\n\n", "frontpage": false}
