{"aid": "39962487", "title": "UserChoice Protection Driver \u2013 UCPD.sys", "url": "https://kolbi.cz/blog/2024/04/03/userchoice-protection-driver-ucpd-sys/", "domain": "kolbi.cz", "votes": 1, "user": "josephcsible", "posted_at": "2024-04-07 18:04:50", "comments": 0, "source_title": "UserChoice Protection Driver \u2013 UCPD.sys", "source_text": "UserChoice Protection Driver \u2013 UCPD.sys \u2013 the kolbicz blog\n\n## the kolbicz blog\n\n### technical geek stuff\n\nMENU\n\n# UserChoice Protection Driver \u2013 UCPD.sys\n\nApril 3, 2024 admin Uncategorized 0\n\nStarting in February, multiple people reported on my blog that setting http\nand https protocols with SetUserFTA and SetDefaultBrowser stopped working for\nthem \u2013 means, changing the Default Browser was not possible anymore with my\ntools. I have compiled a debug version to get more information from the\naffected users/machines and to my surprise, writing to the corresponding\nregistry keys returned ACCESS_DENIED and it was also not possible to edit\nthose keys with regedit, reg.exe or PowerShell anymore.\n\nthe registry keys in question are:\n\nHKCU\\SOFTWARE\\Microsoft\\Windows\\Shell\\Associations\\UrlAssociations\\http\\UserChoice\nHKCU\\SOFTWARE\\Microsoft\\Windows\\Shell\\Associations\\UrlAssociations\\https\\UserChoice\n\nChanging the default browser was still working by using the Settings app in\nWindows, but modifying those keys by scripts or tools seemed to be blocked\nsomehow.\n\nThe first reports were all from Windows 10 Pro users \u2013 and only from private\nenvironments. I created some test VM\u2019s to analyze the issue, but everything\nwas still working fine for me, even after applying the latest windows updates\n\u2013 I was not able to reproduce the issue myself.\n\nI got more reports and wondered whats going on, because none of my VM\u2019s had\nthis \u201cissue\u201d. then \u2013 after some days, multiple reboots and building multiple\nVM\u2019s, suddenly those registry keys were being blocked on some my VM\u2019s too \u2013\nwithout any new updates or changes (at least not visible ones). it somehow\nactivated this \u201cprotection\u201d, but i was not able to trigger this behavior in a\nreliable matter with new VM\u2019s.\n\nI did many, many tests to understand what is going on here. I discovered, that\neven with full permissions or SYSTEM privileges, these registry keys cannot be\nedited anymore. this already smelled like a driver based protection, but why\nand how would Microsoft do something like that? Initially I expected this\n\u201cfeature\u201d to be located in an existing driver, because everything else would\nbe too easy to defeat \u2013 but it turned out, that Microsoft indeed created a\ndedicated driver for this!\n\nI ran a lot of different tests on my VM\u2019s and i figured \u2013 by blackbox testing\n\u2013 that there must be a deny list of specific processes like regedit.exe,\nreg.exe and powershell.exe but that some (Microsoft) processes still can\nmodify those keys \u2013 but no 3rd party utilities anymore.\n\nI also found out that the protection does not run in Windows safe mode \u2013 this\nwas another hint about a driver \u2013 but how can we find out, which driver is\nresponsible for that?\n\nthere are multiple approaches for this and one idea that I had, was really\nstraight forward: if this is a driver, it probably contains the path and names\nof the protected registry keys and we can just \u201cgrep\u201d through the driver files\nand look for the string \u201cUrlAssociations\u201d. drivers are usually located in\nC:\\Windows\\System32\\drivers and have a .sys extension.\n\nhere is a simple PowerShell script that scans all drivers for the string\n\u201cUrlAssociations\u201d:\n\nthat gives only one hit! if we check the properties of UCPD.sys it says:\n\u201cUserChoice Protection Driver\u201d \u2013 that is a really helpful description \u2013 and a\nvery creative name /s\n\nbtw: findstr.exe does not work in this case, because it cannot handle unicode\nstrings.\n\nhere is a screenshot of the drivers properties:\n\ndisassembling this driver confirmed my previous findings: there is a blacklist\nfor processes and also a whitelist for Microsoft signed binaries. check the\nfollowing screenshots:\n\nIsInDenyList \u2013 these binaries cannot modify the protected registry\nkeysIsMicrosoftSignedFile \u2013 this checks if an executable is signed by\nMicrosoft (whitelist) \u2013 these can still modify the protected registry\nkeysStrings of protected registry keys in the driver\n\nfrom this list I noticed that .pdf seems to be protected too and my tests\nconfirmed that. the corresponding registry key is following:\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\FileExts\\\\.pdf\\UserChoice\n\na windows driver can be administered with builtin tools like sc.exe or\nfltmc.exe \u2013 if its a filter driver, which obviously is the case here.\n\nThe driver has the NOT_STOPPABLE attribute setUnloading the filter driver does\nnot work, because the driver doesn\u2019t seems to have an unload function\n\nwe cannot simply unload this driver, BUT we can of course disable it! this can\nbe done by this one-liner \u2013 in an elevated PowerShell followed by a reboot.\n\nNew-ItemProperty -Path \u201cHKLM:\\SYSTEM\\CurrentControlSet\\Services\\UCPD\u201d -Name\n\u201cStart\u201d -Value 4 -PropertyType DWORD -Force\n\nthis brings back the functionality of SetUserFTA, but sadly requires\nadministrative permissions and a reboot.\n\nin my tests I also noticed that there is an UCPDMgr.exe in the system32\ndirectory. disassembling this binary didn\u2019t reveal much. there is code which\nconfigures the driver and changes some other registry keys related to it. it\ndidn\u2019t look like this was useful and I focused more on the driver itself\ntherefore.\n\nbut @GHaslinger found out (his blogpost \u2013 in german), that this binary runs as\na scheduled task and reverts some registry values, if you changed them\nmanually and that it will eventually re-enable the driver! to fully disable\nthe driver, you must also disable the Scheduled Task therefore:\n\nyou can disable this task in a script by using powershell with this command\n(run as administrator):\n\nDisable-ScheduledTask -TaskName \u2018\\Microsoft\\Windows\\AppxDeploymentClient\\UCPD\nvelocity\u2019\n\nafter this change, the driver will not get enabled again and you can use\nSetUserFTA or SetDefaultBrowser without blocking again (if you have disabled\nthe driver too of course).\n\nbut what is this driver all about? does it do other things? what is the point\nof it?\n\nbeside of the http, https and .pdf blocking, there are references to following\nregistry keys in the driver: ShellFeedsTaskbarViewMode, IsFeedsAvailable,\nTaskbarDa, DeviceRegion\n\nall these references hint at the changes that Microsoft announced for the EEA\npolicy in Windows (Widgets, Feeds, Default Browser):\n\nhttps://borncity.com/win/2023/11/17/windows-10-11-changes-due-to-the-european-\ndigital-markets-act/\n\nhttps://www.theverge.com/2023/9/5/23859537/microsoft-windows-11-default-\nbrowser-links-eu-eea-changes\n\nhttps://blogs.windows.com/windows-insider/2023/11/16/previewing-changes-in-\nwindows-to-comply-with-the-digital-markets-act-in-the-european-economic-area\n\nbut i got reports from non-EU users too and the driver gets loaded on machines\noutside of europe as well AND it blocks changing the default browser too. Im\nnot sure if the geo-detection is just buggy or if the reason is a completely\ndifferent one. Microsoft does not have any documentation or announcement about\nthis driver, but the EEA changes were planned to rollout until April 2024 \u2013 so\nthat would actually match.\n\nTL/DR:\n\nMicrosoft implemented a driver based protection to block changes to http/https\nand .pdf associations by 3rd party utilities. the rollout was staggered and\nactivated \u201crandomly\u201d, but in the meantime I got many reports \u2013 also from\nbusiness or education environments (but not Server OS).\n\nMicrosoft also updated the driver during my tests (from 2.0 to 2.1) and\nextended the deny list of executables. this means, they can change the\nbehavior almost on the fly and add new tricks or block additional\nextensions/protocols!\n\nFor this reason, its the safest to disable the driver for the moment \u2013 or if\nyou are brave enough, you can even delete it by using following command (in an\nelevated cmd.exe and reboot afterwards):\n\nsc.exe delete UCPD\n\nwhen you delete it, the UCPDMgr.exe does not activate it again \u2013 at least that\ndidn\u2019t happen in my tests. if you only want to disable the driver you can use\nthese two commands in an elevated powershell:\n\nNew-ItemProperty -Path \u201cHKLM:\\SYSTEM\\CurrentControlSet\\Services\\UCPD\u201d -Name\n\u201cStart\u201d -Value 4 -PropertyType DWORD -Force\n\nDisable-ScheduledTask -TaskName \u2018\\Microsoft\\Windows\\AppxDeploymentClient\\UCPD\nvelocity\u2019\n\nThen you have to reboot and this protection is gone. maybe a future windows\nupdate will re-enable it. we will see.\n\nBut are there other ways around this protection? Yes \u2013 and i will update\nSetUserFTA to work with the activated driver. Im not sure yet, if I will\nrelease another \u201cfree\u201d version with that functionality, but for business\ncustomers I will offer a solution that works without having to disable the\ndriver.\n\nAre there other utilities affected by this \u201cprotection\u201d? Yes, there are\nalready knowledge base articles from VMware and Ivanti:\n\nIssue with DEM FTA and Default Browser settings post applying Feb24/March24\nMonthly windows patches(KB5035845)\n\nhttps://kb.vmware.com/s/article/97169\n\nhttps://forums.ivanti.com/s/article/Restoring-File-types-with-Workspace-\nControl-User-Settings-is-not-working-after-Microsoft-Security-Update\n\nMicrosoft has implemented a very aggressive measure with this driver and\nobviously didn\u2019t think about the impact of it in enterprise environments.\nmaybe we will see additional processes in the whitelist in the future \u2013 but to\nbe honest \u2013 i doubt so.\n\n  * SetUserFTA\n  * UCPD\n\n#### Be the first to comment\n\n### Leave a Reply Cancel reply\n\nYou must be logged in to post a comment.\n\n#### about the author\n\nHi - I am Christoph Kolbicz and im IT-Consultant at AXACOM AG in Switzerland.\nMost of my projects are about Citrix and Microsoft, but i like Security topics\nand sometimes i do some programming and Reverse Engineering.\n\nFollow @_kolbicz I am Microsoft Certified Solution Expert (including Exchange)\nand Citrix Certified Expert - Virtualization and Networking. I hold 30\nMicrosoft MCP and 20+ Citrix CCA certifications - to many to list them here -\nand i am eidg. Dipl. Inf. HF.\n\nDonations: - thanks!\n\n#### Select a Category\n\n  * Citrix\n  * iPhone\n  * Netscaler\n  * Security\n  * Uncategorized\n  * VMware\n  * Windows\n  * XenApp\n\nCopyright \u00a9 2024 | WordPress Theme by MH Themes\n\n", "frontpage": false}
