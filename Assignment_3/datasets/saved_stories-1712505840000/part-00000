{"aid": "39959471", "title": "My New Home Server", "url": "https://g7o.today/posts/my_new_home_server/", "domain": "g7o.today", "votes": 1, "user": "todsacerdoti", "posted_at": "2024-04-07 09:13:13", "comments": 0, "source_title": "My new home server", "source_text": "My new home server \u00b7 g/ianguid/o.today\n\n\u2193Skip to main content\n\n# My new home server\n\nFebruary 19, 2024\u00b76 mins reading time\n\nlearning virtualization home-server\n\nAt the beginning of 2023 I started renting a dedicated server from Hetzner\nwith the intent to self-host several services.\n\nWith an Intel 7th generation CPU, 32GB of RAM and 6 terabytes worth of\nspinning rust, it served me well: my Mastodon single-user instance,\nwallera.computer, used to be hosted there.\n\nBesides some signs of hard disk failure^1, the served chugged along.\n\nAt home, a Raspberry Pi 4 with 8GB of RAM was in charge of handling home\nautomation and Tailscale exit node.\n\nEverything was fine, running smooth... That\u2019s why I felt the need to tear\neverything down and re-do from scratch.\n\n## Requirements! #\n\nI guess I got bitten by the homelabber bug.\n\nAround Christmas I officially decided to decommission the Hetzner server \u2014\nwhich I jokingly called bigboi \u2014 as well as the Raspberry Pi \u2014 much less\namusingly called raspi \u2014 and try finding a replacement for both, that would\nlive at home.\n\nMy demands:\n\n  * Must be physically as compact as possible.\n  * Should allow for some degree of expandability.\n  * Have an Ethernet link capable of at least 1GBit/s.\n  * Low power consumption.\n  * Must allow virtualization.\n  * Have a x86_64 CPU^2.\n  * Repair-friendly.\n  * Supported by mainstream Linux distribution, no vendor kernel needed.\n  * Reasonably priced.\n\nMy attention turned to a series of post by the ServeTheHome folks in which\nthey surveyed various small form-factor thin client computers which\nincidentally are also often decommissioned by their employers for a low price,\nprobably due to planned obsolescence or support contracts ending.\n\nFinding tiny computers is not as hard as one might imagine: there are lots of\nthriving small businesses on eBay refurbishing them and often providing months\nor even years worth of warranty^3.\n\nAmong the several options available, I settled on an HP EliteDesk 800 G4 Mini\n.\n\nIt came with an i7 8700T low-power 12-threads CPU, 16GB of DDR4 RAM and 256GB\nof 2.5\u201d SSD.\n\nIt matches all my requirements for this project:\n\n  * It\u2019s incredibly compact.\n  * Has 2 NVMe and a 2.5\" drive slots.\n  * The integrated Ethernet port is 1Gbit/s, and through an HP proprietary connector one can add an extra 10Gbit/s Ethernet.\n  * The CPU is a T variant, which has lower non-boost clocks to save power.\n  * Has a recent x86_64 instruction set.\n  * Can be completely tore down, has socketed CPU, RAM and storage, has a detailed repair manual freely available online.\n  * Runs mainline Linux just fine.\n  * Can be found for less than 400 euros shipped, with a good hardware selection.\n\nHP says those machines can handle up to 32GB of RAM, but apparently they can\nhandle 64GB just fine.\n\nThe G4 comes in 95W, 65W and 35W versions: while higher wattage boards and\npower supplies handle lower-power CPUs just fine, the opposite is not true.\n\nConsidering you could fit up to an i7 8700K in a G4 Mini, pay special\nattention to what CPU the seller is listing \u2013 mine came with a 65W board and\npower supply.\n\nAll i5 and i7 G4 Mini come stock with Intel vPro with AMT, a great addition if\nyou want to keep it as an home server like me: it\u2019s similar to a KVM but\nwithout the additional BMC board^4.\n\n## Software #\n\nAs you can probably imagine, I like running software on my server^5:\n\n  * Portainer to manage Docker in a user-friendly way\n  * Tailscale , because it\u2019s the best damn personal VPN stack out there\n  * Caddy to serve web pages and forget about renewing LetsEncrypt certificates\n  * Miniflux as my RSS reader\n  * Navidrome to listen to music\n  * A couple Transmission instances for uh, Linux and BSD ISOs\n  * Home Assistant to assist me in handling my home\n  * AdGuard Home to filter out ads\n  * Vaultwarden to manage my passwords\n  * Several containers running Borgmatic , with different SSH key pairs and repositories\n\nInstead of running everything as Docker containers on bare metal, I divided\nthe deployment in two: stuff that will be exposed on the Internet and stuff\nthat won\u2019t.\n\nI started designed with virtual machines in mind, which in turn will run\nDocker containers as their primary mean of deployment.\n\nSince VMWare ESXi for non-commercial uses is not a thing anymore , I chose\nProxmox as my trusty companion.\n\nThe first VM I created was for OpenMediaVault : it exports an internal NVME\nand an USB drive as both NFS and SMB shares.\n\nThe USB one is in charge of handling Time Machine backups for my Mac, while\nthe other acts as general file sharing and archival drive across other virtual\nmachines and computers on the same network.\n\nI added two other VMs:\n\n  * web, in charge of handling Internet-facing services.\n  * home, for everything else.\n\nRead/write access to the storage devices was configured with NFS.\n\nPublic networking was kind of puzzling to figure out: I don\u2019t want to use my\nstatic home IP address to host my website and public services, but I still\nwant some of them available on the wide Internet.\n\nI figured I could connect web to an Oracle free-tier VM through Tailscale, and\nroute all the incoming traffic on ports 80 and 443 to it.\n\nThroughput-wise I have no issues even when streaming lossless music, all\nthrough a small 20MBit^6 upload pipe \u2014 neat!\n\nIn the future I would like to move to a different provider, or rent another\nIPv4 address from my ISP^7.\n\n## Closing thoughts #\n\nNapkin math time:\n\n  * total hardware cost: ~600 Euros.\n  * considering a worst-case power requirement of about 65w, the total cost of owning and operating this setup is about 5.50 Euros/month at the current energy market rate of 0.13 Euros/kWh, plus 30 Euros/month for the Internet connection.\n  * hosting a dedicated server on Hetzner with similar specs \u2014 but lower performance due to spinning rust \u2014 came to ~45 Euros/month\n  * I cut server hosting spending by more than 20%.\n\nCost reduction aside, knowing I\u2019m in control of my data \u2014 and my outages! \u2014\nbrings me a warm and fuzzy feeling, something a dedicated server in a remote\nlocation can hardly match.\n\nIn the future I\u2019d love to buy more bulk storage space to get rid of the\nvarious USB HDD\u2019s I have laying around^8 and also place all the network and\ncomputing devices behind a couple UPSes.\n\n  1. Which apparently you can have fixed by Hetzner, just ask! \u21a9\ufe0e\n\n  2. I strongly believe the market for ARM-based non-enterprise boards is still too fragmented and hobby-oriented \u2014 finding a single-board computer that is as flexible and well-supported as an x86_64 machine is hard. \u21a9\ufe0e\n\n  3. That is, they\u2019ll help you troubleshoot problems and issue a replacement unit or parts if applicable. \u21a9\ufe0e\n\n  4. Depending on your threat model you might want to disable vPro/AMT completely, since it runs on the \u201chidden\u201d operating system some Intel CPUs run. I\u2019m fine with leaving it enabled, my trusted computing needs aren\u2019t fulfilled by this machine anyway. \u21a9\ufe0e\n\n  5. I should update my uses page as well. \u21a9\ufe0e\n\n  6. As I\u2019m writing this I see a fiber-to-the-home cabinet being installed outside my window, 200Mbit/s upload speeds should become a reality soon. \u21a9\ufe0e\n\n  7. Sounds like a perfect job for IPv6! \u21a9\ufe0e\n\n  8. I\u2019ve yet to get bitten by the data hoarder bug. \u21a9\ufe0e\n\n\u2190\u2192 My high-range gravel drivetrain November 9, 2023 Thoughts on the Clicks\nKeyboard March 16, 2024 \u2192\u2190\n\n\u2191\n\nGianguido (gsora) Sor\u00e0\n\nPowered by Hugo & what remains of Congo\n\n", "frontpage": false}
