{"aid": "40009503", "title": "Kaslr offset exposure in Xen through world-readable /sys/kernel/notes", "url": "https://lore.kernel.org/all/202402180028.6DB512C50@keescook/", "domain": "kernel.org", "votes": 1, "user": "thewisenerd", "posted_at": "2024-04-12 04:54:41", "comments": 0, "source_title": "Re: [RESEND RFC] kernel/ksysfs.c: restrict /sys/kernel/notes to root access - Kees Cook", "source_text": "Re: [RESEND RFC] kernel/ksysfs.c: restrict /sys/kernel/notes to root access -\nKees Cook\n\n    \n    \n    From: Kees Cook <keescook@chromium.org> To: Greg KH <gregkh@linuxfoundation.org> Cc: Guixiong Wei <guixiongwei@gmail.com>, linux-hardening@vger.kernel.org, Juergen Gross <jgross@suse.com>, Boris Ostrovsky <boris.ostrovsky@oracle.com>, Stefano Stabellini <sstabellini@kernel.org>, Oleksandr Tyshchenko <oleksandr_tyshchenko@epam.com>, Guixiong Wei <weiguixiong@bytedance.com>, linux-kernel@vger.kernel.org Subject: Re: [RESEND RFC] kernel/ksysfs.c: restrict /sys/kernel/notes to root access Date: Sun, 18 Feb 2024 01:04:48 -0800 [thread overview] Message-ID: <202402180028.6DB512C50@keescook> (raw) In-Reply-To: <2024021825-skiing-trustee-a56a@gregkh> On Sun, Feb 18, 2024 at 08:47:03AM +0100, Greg KH wrote: > On Sun, Feb 18, 2024 at 03:35:01PM +0800, Guixiong Wei wrote: > > From: Guixiong Wei <weiguixiong@bytedance.com> > > > > Restrict non-privileged user access to /sys/kernel/notes to > > avoid security attack. > > > > The non-privileged users have read access to notes. The notes > > expose the load address of startup_xen. This address could be > > used to bypass KASLR. > > How can it be used to bypass it? > > KASLR is, for local users, pretty much not an issue, as that's not what > it protects from, only remote ones. > > > For example, the startup_xen is built at 0xffffffff82465180 and > > commit_creds is built at 0xffffffff810ad570 which could read from > > the /boot/System.map. And the loaded address of startup_xen is > > 0xffffffffbc265180 which read from /sys/kernel/notes. So the loaded > > address of commit_creds is 0xffffffffbc265180 - (0xffffffff82465180 > > - 0xffffffff810ad570) = 0xffffffffbaead570. > > I've cc: the hardening list on this, I'm sure the developers there have > opinions about this. Oh eww, why is Xen spewing addresses into the notes section? (This must be how it finds its entry point? But that would be before relocations happen...) But yes, I can confirm that relocations are done against the .notes section at boot, so the addresses exposed in .notes is an immediate KASLR offset exposure. In /sys/kernel/notes (are there any tools to read this? I wrote my own...) type: 1 name: Xen desc: 0xb4a711c0 0xffffffff which matches a privileged read of /proc/kallsysms: ffffffffb4a711c0 T startup_xen (and the hypercall_page too) There are all coming from arch/x86/xen/xen-head.S: ELFNOTE(Xen, XEN_ELFNOTE_GUEST_OS, .asciz \"linux\") ELFNOTE(Xen, XEN_ELFNOTE_GUEST_VERSION, .asciz \"2.6\") ELFNOTE(Xen, XEN_ELFNOTE_XEN_VERSION, .asciz \"xen-3.0\") #ifdef CONFIG_XEN_PV ELFNOTE(Xen, XEN_ELFNOTE_VIRT_BASE, _ASM_PTR __START_KERNEL_map) /* Map the p2m table to a 512GB-aligned user address. */ ELFNOTE(Xen, XEN_ELFNOTE_INIT_P2M, .quad (PUD_SIZE * PTRS_PER_PUD)) ELFNOTE(Xen, XEN_ELFNOTE_ENTRY, _ASM_PTR startup_xen) ... Introduced in commit 5ead97c84fa7 (\"xen: Core Xen implementation\") Exposed in commit da1a679cde9b (\"Add /sys/kernel/notes\") Amazingly these both went in on the same release (v2.6.23, 2007). This has been exposed for longer than KASLR has been upstream. :P > > > Signed-off-by: Guixiong Wei <weiguixiong@bytedance.com> > > --- > > kernel/ksysfs.c | 2 +- > > 1 file changed, 1 insertion(+), 1 deletion(-) > > > > diff --git a/kernel/ksysfs.c b/kernel/ksysfs.c > > index b1292a57c2a5..09bc0730239b 100644 > > --- a/kernel/ksysfs.c > > +++ b/kernel/ksysfs.c > > @@ -199,7 +199,7 @@ static ssize_t notes_read(struct file *filp, struct kobject *kobj, > > static struct bin_attribute notes_attr __ro_after_init = { > > .attr = { > > .name = \"notes\", > > - .mode = S_IRUGO, > > + .mode = S_IRUSR, > > }, > > .read = &notes_read, > > }; Yes please. Reviewed-by: Kees Cook <keescook@chromium.org> I wonder if we should also remove relocations that are aimed at the .notes section for good measure? If that had already been true, this would have just given the same info as System.map. > > No objection from me, but what userspace tool requires access to this > file today? Will it break if permissions are changed on it? > > And what about the module notes files? If you change one, shouldn't you > change all? Luckily all of _those_ contain what I'd expect: the Linux and GNU.build-id notes, which are harmless. But if we're going to suddenly have things appearing in here, let's make those root-only too. -Kees -- Kees Cook\n    \n    \n    next prev parent reply other threads:[~2024-02-18 9:04 UTC|newest] Thread overview: 7+ messages / expand[flat|nested] mbox.gz Atom feed top 2024-02-18 7:35 [RESEND RFC] kernel/ksysfs.c: restrict /sys/kernel/notes to root access Guixiong Wei 2024-02-18 7:47 ` Greg KH 2024-02-18 9:04 ` Kees Cook [this message] 2024-02-19 11:41 ` Guixiong Wei 2024-02-19 13:07 ` J\u00fcrgen Gro\u00df 2024-02-19 13:21 ` Jann Horn [not found] <CAJe52t-XxSn2rK+wEg1hNAdsPdq+TO-fj3wEYPK_eBH0d-bsSg@mail.gmail.com> 2024-02-18 7:16 ` Greg KH\n    \n    \n    Reply instructions: You may reply publicly to this message via plain-text email using any one of the following methods: * Save the following mbox file, import it into your mail client, and reply-to-all from there: mbox Avoid top-posting and favor interleaved quoting: https://en.wikipedia.org/wiki/Posting_style#Interleaved_style * Reply using the --to, --cc, and --in-reply-to switches of git-send-email(1): git send-email \\ --in-reply-to=202402180028.6DB512C50@keescook \\ --to=keescook@chromium.org \\ --cc=boris.ostrovsky@oracle.com \\ --cc=gregkh@linuxfoundation.org \\ --cc=guixiongwei@gmail.com \\ --cc=jgross@suse.com \\ --cc=linux-hardening@vger.kernel.org \\ --cc=linux-kernel@vger.kernel.org \\ --cc=oleksandr_tyshchenko@epam.com \\ --cc=sstabellini@kernel.org \\ --cc=weiguixiong@bytedance.com \\ /path/to/YOUR_REPLY https://kernel.org/pub/software/scm/git/docs/git-send-email.html * If your mail client supports setting the In-Reply-To header via mailto: links, try the mailto: link\n\nBe sure your reply has a Subject: header at the top and a blank line before\nthe message body.\n\n    \n    \n    This is an external index of several public inboxes, see mirroring instructions on how to clone and mirror all data and code used by this external index.\n\n", "frontpage": false}
